<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for digest-fetch-src.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="prettify.css" />
    <link rel="stylesheet" href="base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="index.html">All files</a> digest-fetch-src.js
    </h1>
    <div class='clearfix'>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">37x</span>
<span class="cline-any cline-yes">37x</span>
<span class="cline-any cline-yes">37x</span>
<span class="cline-any cline-yes">27x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">224x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/// !-----------------------------------------------------------------------------------------------------------
/// |  
//  |  `digest-fetch` is a wrapper of `node-fetch` or `fetch` to provide http digest authentication boostraping.
//  |
/// !-----------------------------------------------------------------------------------------------------------
&nbsp;
const canRequire = typeof(require) == 'function'
<span class="missing-if-branch" title="else path not taken" >E</span>if (typeof(fetch) !== 'function' &amp;&amp; canRequire) var fetch = require('node-fetch')
// if (typeof(cryptojs) !== 'function' &amp;&amp; canRequire) var cryptojs = require('crypto-js')
const cryptojs = require('crypto-js')
const base64 = require('base-64')
&nbsp;
const supported_algorithms = ['MD5', 'MD5-sess']
&nbsp;
const parse = (raw, field, trim=true) =&gt; {
  const regex = new RegExp(`${field}=("[^"]*"|[^,]*)`, "i")
  const match = regex.exec(raw)
  if (match)
    return trim ? match[1].replace(/[\s"]/g, '') : match[1]
  return null
}
&nbsp;
class DigestClient {
  constructor(user, password, options={}) {
    this.user = user
    this.password = password
    this.nonceRaw = 'abcdef0123456789'
    this.logger = options.logger
    this.precomputedHash = options.precomputedHash
&nbsp;
    let algorithm = options.algorithm || 'MD5'
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!supported_algorithms.includes(algorithm)) {
<span class="cstat-no" title="statement not covered" >      if (this.logger) <span class="cstat-no" title="statement not covered" >this.logger.warn(`Unsupported algorithm ${algorithm}, will try with MD5`)</span></span>
<span class="cstat-no" title="statement not covered" >      algorithm = 'MD5'</span>
    }
    this.digest = { nc: 0, algorithm, realm: '' }
    this.hasAuth = false
    const _cnonceSize = parseInt(options.cnonceSize)
    this.cnonceSize = isNaN(_cnonceSize) ? 32 : <span class="branch-1 cbranch-no" title="branch not covered" >_cnonceSize </span>// cnonce length 32 as default
&nbsp;
    // Custom authentication failure code for avoiding browser prompt:
    // https://stackoverflow.com/questions/9859627/how-to-prevent-browser-to-invoke-basic-auth-popup-and-handle-401-error-using-jqu
    this.statusCode = options.statusCode || 401
    this.basic = options.basic || false
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  as</span>ync fetch (url, options=<span class="branch-0 cbranch-no" title="branch not covered" >{})</span> {
<span class="cstat-no" title="statement not covered" >    if (this.basic) <span class="cstat-no" title="statement not covered" >return fetch(url, this.addBasicAuth(options))</span></span>
    const resp = <span class="cstat-no" title="statement not covered" >await fetch(url, this.addAuth(url, options))</span>
<span class="cstat-no" title="statement not covered" >    if (resp.status == this.statusCode) {</span>
<span class="cstat-no" title="statement not covered" >      this.hasAuth = false</span>
<span class="cstat-no" title="statement not covered" >      await this.parseAuth(resp.headers.get('www-authenticate'))</span>
<span class="cstat-no" title="statement not covered" >      if (this.hasAuth) {</span>
        const respFinal = <span class="cstat-no" title="statement not covered" >await fetch(url, this.addAuth(url, options))</span>
<span class="cstat-no" title="statement not covered" >        if (respFinal.status == this.statusCode) {</span>
<span class="cstat-no" title="statement not covered" >          this.hasAuth = false</span>
        } else {
<span class="cstat-no" title="statement not covered" >          this.digest.nc++</span>
        }
<span class="cstat-no" title="statement not covered" >        return respFinal</span>
      }
    } else <span class="cstat-no" title="statement not covered" >this.digest.nc++</span>
<span class="cstat-no" title="statement not covered" >    return resp</span>
  }
&nbsp;
  addBasicAuth (options={}) {
    let _options = {}
    <span class="missing-if-branch" title="if path not taken" >I</span>if (typeof(options.factory) == 'function') {
<span class="cstat-no" title="statement not covered" >      _options = options.factory()</span>
    } else {
      _options = options
    }
&nbsp;
    const auth = 'Basic ' + base64.encode(this.user + ":" + this.password)
    _options.headers = _options.headers || {}
    _options.headers.Authorization = auth
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.logger) <span class="cstat-no" title="statement not covered" >this.logger.debug(options)</span>
    return _options
  }
&nbsp;
  static computeHash(user, realm, password) {
    return cryptojs.MD5(`${user}:${realm}:${password}`).toString();
  }
&nbsp;
  addAuth (url, options) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (typeof(options.factory) == 'function') <span class="cstat-no" title="statement not covered" >options = options.factory()</span>
    if (!this.hasAuth) return options
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.logger) <span class="cstat-no" title="statement not covered" >this.logger.info(`requesting with auth carried`)</span>
&nbsp;
    const isRequest = typeof(url) === 'object' &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >typeof(url.url) === 'string'</span>
    const urlStr = isRequest ? <span class="branch-0 cbranch-no" title="branch not covered" >url.url </span>: url
    const _url = urlStr.replace('//', '')
    const uri = _url.indexOf('/') == -1 ? <span class="branch-0 cbranch-no" title="branch not covered" >'/' </span>: _url.slice(_url.indexOf('/'))
    const method = options.method ? options.method.toUpperCase() : <span class="branch-1 cbranch-no" title="branch not covered" >'GET'</span>
&nbsp;
    let ha1 = this.precomputedHash ? this.password : DigestClient.computeHash(this.user, this.digest.realm, this.password)
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.digest.algorithm === 'MD5-sess') {
<span class="cstat-no" title="statement not covered" >      ha1 = cryptojs.MD5(`${ha1}:${this.digest.nonce}:${this.digest.cnonce}`).toString()</span>
    }
&nbsp;
    // optional MD5(entityBody) for 'auth-int'
    let _ha2 = '' 
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.digest.qop === 'auth-int') {
      // not implemented for auth-int
<span class="cstat-no" title="statement not covered" >      if (this.logger) <span class="cstat-no" title="statement not covered" >this.logger.warn('Sorry, auth-int is not implemented in this plugin')</span></span>
      // const entityBody = xxx
      // _ha2 = ':' + cryptojs.MD5(entityBody).toString()
    }
    const ha2 = cryptojs.MD5(`${method}:${uri}${_ha2}`).toString()
&nbsp;
    const ncString = ('00000000'+this.digest.nc).slice(-8)
&nbsp;
    let _response = `${ha1}:${this.digest.nonce}:${ncString}:${this.digest.cnonce}:${this.digest.qop}:${ha2}`
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!this.digest.qop) <span class="cstat-no" title="statement not covered" >_response = `${ha1}:${this.digest.nonce}:${ha2}`</span>
    const response = cryptojs.MD5(_response).toString()
&nbsp;
    const opaqueString = this.digest.opaque !== null ? <span class="branch-0 cbranch-no" title="branch not covered" >`opaque="${this.digest.opaque}",` </span>: ''
    const qopString = this.digest.qop ? `qop="${this.digest.qop}",` : <span class="branch-1 cbranch-no" title="branch not covered" >''</span>
    const digest = `${this.digest.scheme} username="${this.user}",realm="${this.digest.realm}",\
nonce="${this.digest.nonce}",uri="${uri}",${opaqueString}${qopString}\
algorithm="${this.digest.algorithm}",response="${response}",nc=${ncString},cnonce="${this.digest.cnonce}"`
    options.headers = options.headers || {}
    options.headers.Authorization = digest
    <span class="missing-if-branch" title="if path not taken" >I</span>if (this.logger) <span class="cstat-no" title="statement not covered" >this.logger.debug(options)</span>
&nbsp;
    // const {factory, ..._options} = options
    const _options = {}
    Object.assign(_options, options)
    delete _options.factory
    return _options;
  }
&nbsp;
  async parseAuth (h) {
    this.lastAuth = h
&nbsp;
    if (!h || h.length &lt; 5) {
      this.hasAuth = false
      return
    }
&nbsp;
    this.hasAuth = true
    
    this.digest.scheme = h.split(/\s/)[0]
&nbsp;
    this.digest.realm = (parse(h, 'realm', false) || <span class="branch-1 cbranch-no" title="branch not covered" >'')</span>.replace(/["]/g, '')
&nbsp;
    this.digest.qop = this.parseQop(h)
&nbsp;
    this.digest.opaque = parse(h, 'opaque')
    
    this.digest.nonce = parse(h, 'nonce') || ''
&nbsp;
    this.digest.cnonce = this.makeNonce()
    this.digest.nc++
  }
&nbsp;
  parseQop (rawAuth) {
    // Following https://en.wikipedia.org/wiki/Digest_access_authentication
    // to parse valid qop
    // Samples 
    // : qop="auth,auth-init",realm=
    // : qop=auth,realm=
    const _qop = parse(rawAuth, 'qop')
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (_qop !== null) {
      const qops = _qop.split(',')
      if (qops.includes('auth')) return 'auth'
      else <span class="missing-if-branch" title="else path not taken" >E</span>if (qops.includes('auth-int')) return 'auth-int'
    }
    // when not specified
<span class="cstat-no" title="statement not covered" >    return null</span>
  }
&nbsp;
  makeNonce () {
    let uid = ''
    for (let i = 0; i &lt; this.cnonceSize; ++i) {
      uid += this.nonceRaw[Math.floor(Math.random() * this.nonceRaw.length)];
    }
    return uid
  }
&nbsp;
  static parse(...args) {
    return parse(...args)
  }
}
&nbsp;
<span class="missing-if-branch" title="if path not taken" >I</span>if (typeof(window) === "object") <span class="cstat-no" title="statement not covered" >window.DigestFetch = DigestClient</span>
module.exports = DigestClient
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Sep 17 2020 03:48:54 GMT+0800 (China Standard Time)
</div>
</div>
<script src="prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="sorter.js"></script>
</body>
</html>
